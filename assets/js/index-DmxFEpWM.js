/* empty css             *//* empty css                  *//* empty css                   */import"./el-tooltip-l0sNRNKZ.js";/* empty css                  *//* empty css                    *//* empty css                  */import{d as O,p as g,Y as E,q as A,i as j,o as G,w as l,a as k,b as n,u as o,D as H,e as u,x as K,bX as Q,O as X,ag as Y,k as F,aK as J,aM as Z,Q as ee,bI as te,t as y,a7 as ae,B as $,a8 as ie,W as S,V as v,aV as ne,bS as h}from"./index-yDSqlga2.js";import{_ as se}from"./index.vue_vue_type_script_setup_true_name_ProTable_lang-dQS8jH7J.js";import le from"./index-bWYkY3oD.js";import{_ as oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                 *//* empty css                    *//* empty css               *//* empty css                 *//* empty css                */import"./el-form-item-l0sNRNKZ.js";/* empty css                 *//* empty css                  *//* empty css                     *//* empty css                 *//* empty css                  */import"./sortable.esm-C83syoBY.js";/* empty css                  *//* empty css                  *//* empty css                        *//* empty css                   *//* empty css                       */import"./index.vue_vue_type_script_setup_true_lang-BkdJC_33.js";import"./index-BywwBxeg.js";const re={class:"table-box aw-card"},de={class:"flex items-center gap-4"},ue={class:"move"},pe={class:"drawer-footer"},ce=O({__name:"index",props:{visible:{type:Boolean,default:!1},planData:{type:Object,default:()=>({})},userList:{type:Array,default:()=>[]}},emits:["update:visible","update:planData","refresh"],setup(b,{emit:I}){const r=b,d=I,p=g(r.visible),x=g(),B=g([{prop:"num",label:"序号",width:60},{prop:"description",label:"子任务描述",minWidth:180},{prop:"assignee",label:"负责人",width:150},{prop:"equipment",label:"使用设备",width:150},{prop:"startTime",label:"计划开始时间",width:180},{prop:"endTime",label:"计划结束时间",width:180},{prop:"actualStartTime",label:"实际开始时间",width:180},{prop:"actualEndTime",label:"实际结束时间",width:180},{prop:"duration",label:"计划用时",width:120},{prop:"actualDuration",label:"实际用时",width:120},{prop:"progress",label:"完成情况",minWidth:200},{prop:"remark",label:"备注",minWidth:150},{prop:"operation",label:"操作",width:420,fixed:"right"}]),m=g(!1),w=g(!1),T=g({id:"",description:"",assigneeId:"",equipment:"",timeRange:[],actualTimeRange:[],duration:1,actualDuration:void 0,progress:0,remark:""}),_=e=>{const t=r.userList.find(i=>i.id===e);return t?t.name:"未分配"},R=e=>e===100?"success":e>=80?"warning":"",V=()=>{w.value=!1,T.value={id:"",description:"",assigneeId:"",equipment:"",timeRange:[],actualTimeRange:[],duration:1,actualDuration:void 0,progress:0,remark:""},m.value=!0},q=e=>{w.value=!0,T.value={id:e.id,description:e.description,assigneeId:e.assigneeId,equipment:e.equipment||"",timeRange:[e.startTime,e.endTime],actualTimeRange:e.actualStartTime&&e.actualEndTime?[e.actualStartTime,e.actualEndTime]:[],duration:e.duration,actualDuration:e.actualDuration,progress:e.progress,remark:e.remark},m.value=!0},N=e=>{S.confirm("确定要删除该子任务吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{if(r.planData.subtasks){const t={...r.planData,subtasks:r.planData.subtasks.filter(i=>i.id!==e)};d("update:planData",t),v.success("删除成功"),d("refresh")}}).catch(()=>{})},P=e=>{const t={...r.planData};if(t.subtasks||(t.subtasks=[]),w.value){const i=t.subtasks.findIndex(a=>a.id===e.id);i!==-1&&(t.subtasks[i]={...t.subtasks[i],...e},v.success("子任务更新成功"))}else{const i={...e,id:ne()};t.subtasks.push(i),v.success("子任务添加成功")}d("update:planData",t),m.value=!1,d("refresh")},M=()=>{d("refresh"),p.value=!1,v.success("子任务保存成功")},C=(e,t)=>{if(!r.planData.subtasks)return;const i={...r.planData},a=[...i.subtasks];t==="up"&&e>0?[a[e],a[e-1]]=[a[e-1],a[e]]:t==="down"&&e<a.length-1&&([a[e],a[e+1]]=[a[e+1],a[e]]),i.subtasks=a,d("update:planData",i)};function U(e){var t;(t=x.value)==null||t.tableData}E(()=>r.visible,e=>{p.value=e}),E(()=>p.value,e=>{d("update:visible",e)});const W=e=>{S.confirm("确认将此子任务标记为完成吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}).then(()=>{const t={...r.planData},i=t.subtasks||[],a=i.findIndex(f=>f.id===e.id);if(a!==-1){if(i[a]={...i[a],progress:100,actualEndTime:new Date().toISOString().slice(0,16).replace("T"," "),actualDuration:i[a].actualDuration||i[a].duration},a<i.length-1){const f=i[a+1],D=_(f.assigneeId);h({title:"任务通知",message:`当前子任务已完成，下一步由 ${D} 负责的"${f.description}"任务可以开始了`,type:"success",duration:5e3})}else h({title:"任务通知",message:"所有子任务已完成！",type:"success",duration:5e3});t.subtasks=i,d("update:planData",t),v.success("子任务已标记为完成"),d("refresh")}}).catch(()=>{})},z=e=>{S.confirm("确认为此子任务生成报告吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}).then(()=>{e.id,e.description,_(e.assigneeId),e.equipment,e.startTime,e.endTime,e.actualStartTime,e.actualEndTime,e.duration,e.actualDuration,e.progress,e.remark,h({title:"报告生成成功",message:`已为子任务"${e.description}"生成报告`,type:"success",duration:3e3})}).catch(()=>{})};return A(()=>{}),(e,t)=>{const i=K,a=H,f=te,D=J,L=ie;return G(),j(L,{modelValue:o(p),"onUpdate:modelValue":t[2]||(t[2]=s=>$(p)?p.value=s:null),title:`${b.planData.taskName||"计划"} - 子任务列表`,size:"100%","destroy-on-close":""},{footer:l(()=>[k("div",pe,[n(a,{onClick:t[1]||(t[1]=s=>p.value=!1)},{default:l(()=>t[9]||(t[9]=[u("取消")])),_:1}),n(a,{type:"primary",onClick:M},{default:l(()=>t[10]||(t[10]=[u("保存")])),_:1})])]),default:l(()=>[k("div",re,[n(se,{ref_key:"subtaskTableRef",ref:x,columns:o(B),data:b.planData.subtasks||[],class:"move","row-key":"id",pagination:!1,onDragSort:U},{tableHeader:l(()=>[k("div",de,[n(a,{type:"primary",onClick:V},{default:l(()=>[n(i,null,{default:l(()=>[n(o(ae))]),_:1}),t[3]||(t[3]=u("新增子任务 "))]),_:1}),t[4]||(t[4]=k("div",{class:"text-sm text-gray-400"},"可点击操作列排序按钮或者鼠标点击按住序号列进行任务排序",-1))])]),num:l(s=>[k("div",ue,y(s.$index+1),1)]),assignee:l(s=>[u(y(_(s.row.assigneeId)),1)]),duration:l(s=>[u(y(s.row.duration)+"小时 ",1)]),progress:l(s=>[n(f,{percentage:s.row.progress,status:R(s.row.progress)},null,8,["percentage","status"])]),operation:l(s=>[n(a,{type:"primary",link:"",onClick:c=>q(s.row)},{default:l(()=>[n(i,null,{default:l(()=>[n(o(Q))]),_:1}),t[5]||(t[5]=u("编辑 "))]),_:2},1032,["onClick"]),n(a,{type:"danger",link:"",onClick:c=>N(s.row.id)},{default:l(()=>[n(i,null,{default:l(()=>[n(o(X))]),_:1}),t[6]||(t[6]=u("删除 "))]),_:2},1032,["onClick"]),n(a,{type:"success",link:"",onClick:c=>W(s.row),disabled:s.row.progress===100},{default:l(()=>[n(i,null,{default:l(()=>[n(o(Y))]),_:1}),t[7]||(t[7]=u("完成 "))]),_:2},1032,["onClick","disabled"]),n(a,{type:"info",link:"",onClick:c=>z(s.row)},{default:l(()=>[n(i,null,{default:l(()=>[n(o(F))]),_:1}),t[8]||(t[8]=u("生成报告 "))]),_:2},1032,["onClick"]),n(D,{effect:"dark",content:"向上",placement:"left"},{default:l(()=>[n(a,{type:"primary",size:"small",icon:o(Z),circle:"",disabled:s.$index===0,onClick:c=>C(s.$index,"up")},null,8,["icon","disabled","onClick"])]),_:2},1024),n(D,{effect:"dark",content:"向下",placement:"right"},{default:l(()=>{var c;return[n(a,{type:"primary",size:"small",icon:o(ee),circle:"",disabled:s.$index===(((c=b.planData.subtasks)==null?void 0:c.length)||0)-1,onClick:me=>C(s.$index,"down")},null,8,["icon","disabled","onClick"])]}),_:2},1024)]),_:1},8,["columns","data"])]),n(le,{visible:o(m),"onUpdate:visible":t[0]||(t[0]=s=>$(m)?m.value=s:null),"is-edit":o(w),"subtask-data":o(T),"user-list":b.userList,onSubmit:P},null,8,["visible","is-edit","subtask-data","user-list"])]),_:1},8,["modelValue","title"])}}}),je=oe(ce,[["__scopeId","data-v-d1e169aa"]]);export{je as default};
